# 用户模块后端测试文档

## 1. 测试环境

- **服务器:** localhost:8080
- **API基础路径:** /api
- **数据库:** MySQL 8.0 (运行在Docker容器中，端口3307)
- **测试工具:** curl

## 2. 前置条件

- 确保Docker数据库容器正常运行：`docker-compose up -d` (位于database目录)
- 确保Spring Boot应用已启动
- 确保所有表结构正确创建

## 3. 用户注册与登录

### 3.1 用户注册 (POST /users/register)

**请求参数:**
```json
{
  "username": "用户名",
  "password": "密码",
  "email": "邮箱",
  "phone": "手机号",
  "userType": "用户类型"
}
```

**注意事项:**
- userType必须是枚举值中的一个：NORMAL_USER（普通用户）、DEALER（经销商）或ADMIN（管理员）
- 邮箱格式必须正确
- 手机号格式必须为中国大陆11位手机号格式
- 用户名长度必须在3-20个字符之间
- 密码长度必须在6-20个字符之间

**测试用例:**
```bash
curl -X POST "http://localhost:8080/api/users/register" -H "Content-Type: application/json" -d '{"username":"testuser1","password":"Password123","email":"testuser1@example.com","phone":"13800138001","userType":"NORMAL_USER"}'
```

**预期结果:**
```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "userId": 8,
    "username": "testuser1",
    "password": "Password123",
    "email": "testuser1@example.com",
    "phone": "13800138001",
    "userType": "NORMAL_USER",
    "registerTime": "2025-03-05T02:19:56.602+00:00",
    "lastLoginTime": null,
    "status": 1,
    "avatar": null
  }
}
```

### 3.2 用户登录 (POST /users/login)

**请求参数:**
```json
{
  "loginIdentity": "登录标识（邮箱或手机号）",
  "password": "密码",
  "loginType": "登录类型"
}
```

**注意事项:**
- loginType必须是"email"或"phone"（小写）
- 登录失败会返回"用户名或密码错误"

**测试用例:**
```bash
curl -X POST "http://localhost:8080/api/users/login" -H "Content-Type: application/json" -d '{"loginIdentity":"testuser1@example.com","password":"Password123","loginType":"email"}'
```

**预期结果:**
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "user": {
      "userId": 8,
      "username": "testuser1",
      "password": "Password123",
      "email": "testuser1@example.com",
      "phone": "13800138001",
      "userType": "NORMAL_USER",
      "registerTime": "2025-03-05T02:19:57.000+00:00",
      "lastLoginTime": "2025-03-05T02:21:10.372+00:00",
      "status": 1,
      "avatar": null
    },
    "tokenInfo": {
      "tokenName": "Authorization",
      "tokenValue": "47518a72-af27-456d-99b4-6becc6a5d42b",
      "isLogin": true,
      "loginId": "8",
      "loginType": "login",
      "tokenTimeout": 2591999,
      "sessionTimeout": 2591999,
      "tokenSessionTimeout": -2,
      "tokenActiveTimeout": -1,
      "loginDevice": "default-device",
      "tag": null
    }
  }
}
```

### 3.3 用户登出 (POST /users/logout)

**请求头:**
- Authorization: 用户登录时获取的token

**测试用例:**
```bash
curl -X POST "http://localhost:8080/api/users/logout" -H "Authorization: 47518a72-af27-456d-99b4-6becc6a5d42b"
```

**预期结果:**
```json
{
  "code": 200,
  "message": "登出成功",
  "data": null
}
```

## 4. 用户资料管理

### 4.1 获取用户资料 (GET /users/profile)

**请求头:**
- Authorization: 用户登录时获取的token

**测试用例:**
```bash
curl -X GET "http://localhost:8080/api/users/profile" -H "Authorization: 47518a72-af27-456d-99b4-6becc6a5d42b"
```

**预期结果:**
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "userId": 8,
    "username": "testuser1",
    "password": "Password123",
    "email": "testuser1@example.com",
    "phone": "13800138001",
    "userType": "NORMAL_USER",
    "registerTime": "2025-03-05T02:19:57.000+00:00",
    "lastLoginTime": "2025-03-05T02:21:10.000+00:00",
    "status": 1,
    "avatar": null
  }
}
```

### 4.2 更新用户资料 (PUT /users/profile)

**请求头:**
- Authorization: 用户登录时获取的token

**请求参数:**
```json
{
  "email": "更新后的邮箱",
  "phone": "更新后的手机号"
}
```

**测试用例:**
```bash
curl -X PUT "http://localhost:8080/api/users/profile" -H "Authorization: 47518a72-af27-456d-99b4-6becc6a5d42b" -H "Content-Type: application/json" -d '{"email":"updated.testuser1@example.com","phone":"13900139001"}'
```

**预期结果:**
```json
{
  "code": 200,
  "message": "更新成功",
  "data": {
    "userId": 8,
    "username": "testuser1",
    "password": "Password123",
    "email": "updated.testuser1@example.com",
    "phone": "13900139001",
    "userType": "NORMAL_USER",
    "registerTime": "2025-03-05T02:19:57.000+00:00",
    "lastLoginTime": "2025-03-05T02:22:21.000+00:00",
    "status": 1,
    "avatar": null
  }
}
```

### 4.3 上传头像 (POST /users/avatar)

**请求头:**
- Authorization: 用户登录时获取的token
- Content-Type: multipart/form-data

**请求参数:**
- file: 图片文件（支持格式：JPG、PNG、GIF，最大2MB）

**测试用例:**
```bash
curl -X POST "http://localhost:8080/api/users/avatar" -H "Authorization: 47518a72-af27-456d-99b4-6becc6a5d42b" -F "file=@test_avatar.jpg"
```

**预期结果:**
```json
{
  "code": 200,
  "message": "上传成功",
  "data": "http://localhost:8090/images/avatars/avatar_1741141432717.jpg"
}
```

## 5. 用户偏好设置

### 5.1 获取用户偏好设置 (GET /users/preference)

**请求头:**
- Authorization: 用户登录时获取的token

**测试用例:**
```bash
curl -X GET "http://localhost:8080/api/users/preference" -H "Authorization: 47518a72-af27-456d-99b4-6becc6a5d42b"
```

**预期结果 (首次访问):**
```json
{
  "code": 200,
  "message": "获取成功",
  "data": null
}
```

**预期结果 (已设置偏好):**
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "preferenceId": 5,
    "userId": 8,
    "priceMin": 100000.00,
    "priceMax": 500000.00,
    "preferredBrands": "Toyota,Honda",
    "preferredCategories": "SUV,Sedan",
    "otherPreferences": "Low mileage,Good fuel economy",
    "updateTime": "2025-03-05T02:21:46.000+00:00"
  }
}
```

### 5.2 更新用户偏好设置 (PUT /users/preference)

**请求头:**
- Authorization: 用户登录时获取的token

**请求参数:**
```json
{
  "priceMin": 最低价格,
  "priceMax": 最高价格,
  "preferredBrands": "偏好品牌，逗号分隔",
  "preferredCategories": "偏好车型，逗号分隔",
  "otherPreferences": "其他偏好，逗号分隔"
}
```

**测试用例:**
```bash
curl -X PUT "http://localhost:8080/api/users/preference" -H "Authorization: 47518a72-af27-456d-99b4-6becc6a5d42b" -H "Content-Type: application/json" -d '{"priceMin":100000,"priceMax":500000,"preferredBrands":"Toyota,Honda","preferredCategories":"SUV,Sedan","otherPreferences":"Low mileage,Good fuel economy"}'
```

**预期结果:**
```json
{
  "code": 200,
  "message": "更新成功",
  "data": {
    "preferenceId": 5,
    "userId": 8,
    "priceMin": 100000,
    "priceMax": 500000,
    "preferredBrands": "Toyota,Honda",
    "preferredCategories": "SUV,Sedan",
    "otherPreferences": "Low mileage,Good fuel economy",
    "updateTime": "2025-03-05T02:21:46.093+00:00"
  }
}
```

## 6. 经销商管理

### 6.1 提交经销商信息 (POST /dealers/info)

**请求头:**
- Authorization: 经销商用户登录时获取的token

**请求参数:**
```json
{
  "dealerName": "经销商名称",
  "address": "地址",
  "businessLicense": "营业执照号",
  "contactPerson": "联系人",
  "contactPhone": "联系电话",
  "description": "描述"
}
```

**注意事项:**
- 在Windows Git Bash环境下测试时，中文内容可能会导致UTF-8编码问题，建议使用英文

**测试用例:**
```bash
curl -X POST "http://localhost:8080/api/dealers/info" -H "Authorization: 48fa0f76-9c7a-4fe6-850a-83ab2b2e34c5" -H "Content-Type: application/json" -d '{"dealerName":"Test Dealer","address":"Beijing Haidian","businessLicense":"BL12345678","contactPerson":"Mr. Zhang","contactPhone":"13866668888","description":"Professional Car Dealer"}'
```

**预期结果:**
```json
{
  "code": 200,
  "message": "提交成功",
  "data": {
    "dealerId": 3,
    "userId": 9,
    "dealerName": "Test Dealer",
    "address": "Beijing Haidian",
    "businessLicense": "BL12345678",
    "contactPerson": "Mr. Zhang",
    "contactPhone": "13866668888",
    "status": "PENDING",
    "description": "Professional Car Dealer"
  }
}
```

### 6.2 提交经销商审核申请 (POST /dealers/review)

**请求头:**
- Authorization: 经销商用户登录时获取的token

**测试用例:**
```bash
curl -X POST "http://localhost:8080/api/dealers/review" -H "Authorization: 48fa0f76-9c7a-4fe6-850a-83ab2b2e34c5"
```

**预期结果:**
```json
{
  "code": 200,
  "message": "提交审核成功",
  "data": {
    "dealerId": 3,
    "userId": 9,
    "dealerName": "Test Dealer",
    "address": "Beijing Haidian",
    "businessLicense": "BL12345678",
    "contactPerson": "Mr. Zhang",
    "contactPhone": "13866668888",
    "status": "PENDING",
    "description": "Professional Car Dealer"
  }
}
```

### 6.3 获取待审核经销商列表 (GET /dealers/admin/pending)

**请求头:**
- Authorization: 管理员用户登录时获取的token

**测试用例:**
```bash
curl -X GET "http://localhost:8080/api/dealers/admin/pending" -H "Authorization: 8f140930-3071-4d3c-af8a-f672fe0e27a1"
```

**预期结果:**
```json
{
  "code": 200,
  "message": "获取成功",
  "data": [
    {
      "dealerId": 3,
      "userId": 9,
      "dealerName": "Test Dealer",
      "address": "Beijing Haidian",
      "businessLicense": "BL12345678",
      "contactPerson": "Mr. Zhang",
      "contactPhone": "13866668888",
      "status": "PENDING",
      "description": "Professional Car Dealer"
    }
  ]
}
```

## 7. 测试中发现的问题和解决方案

1. **类型转换异常**
   - 问题: 在访问管理员API时，出现`ClassCastException`，Java无法将String转换为Integer
   - 原因: Sa-Token存储的loginId可能是String类型，但代码中直接尝试转为Integer
   - 解决方案: 修改了`StpInterfaceImpl`类中的`getRoleList`和`getPermissionList`方法，增加安全类型转换

2. **UTF-8编码问题**
   - 问题: 在Windows Git Bash环境下提交包含中文的JSON数据时出现编码错误
   - 解决方案: 在测试时使用英文内容，或确保正确的UTF-8编码

3. **命令行执行问题**
   - 问题: 在Git Bash中执行curl命令时可能出现命令解析错误
   - 解决方案: 注意命令格式，避免特殊字符，必要时使用引号或转义符

## 8. 建议及改进方向

1. **密码加密**
   - 当前密码以明文形式存储和传输，建议添加加密机制

2. **审核流程完善**
   - 需实现经销商审核批准的API，参考设计文档中的`POST /api/admin/dealers/{dealer_id}/audit`



